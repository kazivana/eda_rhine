---
title: "Have Middelkoop's predictions come true?"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = F)
knitr::opts_knit$set(root.dir = 'C:/Users/godzi/Documents/eda_rhine')

```


```{r, include=FALSE}
getwd()
```

```{r, include=FALSE}

# Environment setup

#library(ggplot2)
#library(mapview)
#library(data.table)
#library(reshape2)
#library(sf)
#library(moments)

runoff_summary <- readRDS('./data/runoff_summary.rds')
runoff_day <- readRDS('./data/runoff_day.rds')
runoff_month <- readRDS('./data/runoff_month.rds')
runoff_stats <- readRDS('./data/runoff_stats.rds')
runoff_summer <- readRDS('./data/runoff_summer.rds')
runoff_winter <- readRDS('./data/runoff_summer.rds')
runoff_year <- readRDS('./data/runoff_year.rds')

runoff_summary_key <- readRDS('./data/runoff_summary_key.rds')
runoff_day_key <- readRDS('./data/runoff_day_key.rds')
runoff_month_key <- readRDS('./data/runoff_month_key.rds')
runoff_summer_key <- readRDS('./data/runoff_summer_key.rds')
runoff_winter_key <- readRDS('./data/runoff_winter_key.rds')
runoff_year_key <- readRDS('./data/runoff_year_key.rds')

```


In 2001 Middelkoop et al. conducted groundbreaking research into the outflow patterns of the Rhine river in Europe. Their models indicated that rising temperatures were leading to a rise in winter discharge due to increased snow-melt, and a decrease in summer discharge due to lower levels of winter snow storage and increase of evapotranspiration in the warmer months.  

Their results were published in the scientific journal *Climatic Change* and influenced policy makers, as well as hydrological projections for the next two decades. 

The full research paper [_Impact of Climate Change on Hydrological Regimes and Water Resources Management in the Rhine Basin_](https://www.researchgate.net/publication/200043966_Impact_of_Climate_Change_on_Hydrological_Regimes_and_Water_Resources_Management_in_the_Rhine_Basin) is available online. 

Now that twenty years have passed, we are going to dive in to the data and examine whether their predictions have come true. 

### Where are we? 

First, let's have a look at the area we will be covering, and at the geographic distribution of the gauging stations from where we are collecting the data.

```{r, echo = FALSE}

stations <- st_as_sf(runoff_summary, 
                              coords = c("lon", "lat"), 
                              crs = 4326)
stations_map <- mapview(stations, map.types = 'Stamen.TerrainBackground')

stations_map


```

From this map we can see that the stations are well-distributed across the river. We can also take this moment to note that the water is flowing from the Alps to the Baltic. This means that the stations in Switzerland are the first and at the very beginning of the catchment area of the Rhine, while the Netherlands is where the it meets the North sea.  

We can also take a closer look at the stations in this interactive map and learn more about each one, most relevantly the altitude, area and runoff class. 

One imporant thing to point out is that along the river there is a lot of variation in terms of topography. The beginning of the catchment is in the Alpine and pre-Alpine areas where the highest and largest differences in altitude are (range of 300m - 1200m). These areas' runoff is most influenced by snow.  
The river then runs through the German Middle Mountain area with altitudes between 150m and 700m, through the scenic Mosel basin, before reaching the lowlands of the Vecht catchment. There are minimal differences in elevantion in this stage, and it is where groundwater plays its biggest role for water balance of the catchment.

```{r, echo=FALSE, error=FALSE}

dt <- runoff_summary[, .(sname, area, alt_class)]
to_plot <- runoff_stats[dt, on = 'sname']

colset_4 <- c("#D35C37", "#BF9A77", "#D6C6B9", "#97B8C2")
n_stations <- nrow(runoff_summary)

ggplot(to_plot, aes(x = mean_day, y = area, col = sname, cex = alt_class)) +
  geom_point() +
  scale_color_manual(values = colorRampPalette(colset_4)(n_stations)) +
  theme_bw()


```

This graph shows us that the average runoff increases as catchment area increases, as well as that the runoff increases as altitude decreases.  
This is because the catchment area represents the total area from which precipitation is being collected into the river flow. At the very beginning of the river, at the highest altitudes, the catchment area is small. However by the very last stations, where altitude has decreased, the runoff is at its highest due to the entirety of the river's catchment area being behind the stations, collecting runoff to be taken to the North Sea basin. 

### What does the historical data tell us about average seasonal runoff?

The following plots showcase the summer and winter means in runoff for the time periods before 2000, representing the data available to Middelkoop et al., and up to 2016. 


```{r pressure, echo=FALSE}
year_thres <- 2000

to_plot <- rbind(cbind(runoff_winter, season = factor('winter')), 
                 cbind(runoff_summer, season = factor('summer'))) 

to_plot[year < year_thres, period := factor('1950-2000')]
to_plot[year >= year_thres, period := factor('2001-2016')]

to_plot <- to_plot[year >= 1950]

ggplot(to_plot, aes(season, value, fill = period)) +
  geom_boxplot() +
  facet_wrap(~sname, scales = 'free_y') +
  scale_fill_manual(values = colset_4[c(4, 1)]) +
  xlab(label = "Season") +
  ylab(label = "Runoff (m3/s)") +
  theme_bw()

```


One might notice that there is some variation between stations. Middelkoop et al. also noted in their paper that there are differences between the stations due to their locations and topography, which influence the relevant hydrological processes. 
- check whether to use 1980 as a base instead, read through middelkoop again - 


We should also take a closer look through regression analysis. 

```{r, echo = FALSE}

ggplot(runoff_winter, aes(x = year, y = value)) +
  geom_line(col = colset_4[3])+
  geom_point(col = colset_4[3])+
  facet_wrap(~sname, scales = 'free') +
  geom_smooth(method = 'lm', formula = y~x, se = 0, col = colset_4[1]) +
  geom_smooth(method = 'loess', formula = y~x, se = 0, col = colset_4[4]) +
  scale_color_manual(values = colset_4[c(1, 2, 4)]) +
  xlab(label = "Year") +
  ylab(label = "Runoff (m3/s)") +
  theme_bw()

```

```{r, echo = FALSE}

ggplot(runoff_summer, aes(x = year, y = value)) +
  geom_line(col = colset_4[3])+
  geom_point(col = colset_4[3])+
  facet_wrap(~sname, scales = 'free') +
  geom_smooth(method = 'lm', formula = y~x, se = 0, col = colset_4[1]) +
  geom_smooth(method = 'loess', formula = y~x, se = 0, col = colset_4[4]) +
  scale_color_manual(values = colset_4[c(1, 2, 4)]) +
  xlab(label = "Year") +
  ylab(label = "Runoff (m3/s)") +
  theme_bw()
```

We have used two different regression models here, loess and linear, to showcase the trends through two difference lenses. On the one hand, through the loess model we can see in mode detail the variations in runoff through time. Our linear model creates a general trend line which disregards outliers and highlights the encompassing trends. 

We can see above that the summer runoff values are decreasing, while the winter ones are increasing. 


### Conclusion

Looking at the data one could conclude that Middelkoop et al.'s predictions have been proven to be reasonably accurate. The runoff in the winter months has had an upward trend, while the summer months have been experiencing a decrease in runoff. The data supports the hypothesis that rising average temperatures have this effect on the river's discharge, which has important implications for the socities that depend on it as a source of fresh water, as well as economical, agricultural and industry implications. 

Furthermore, we can look at recent events to note the seasonal variations in river discharge. Summer months have shown an increase in low-flow reports, such as the events in [2018](https://www.dw.com/en/germany-swelters-under-heat-wave/a-44839919) and [2019](https://rivercruisepassenger.com.au/heatwave-and-low-water-levels-in-europe-may-force-river-cruise-itinerary-changes/). On the other hand, winter reports showcase the dangers of rising discharge levels, as in February of [2020](https://www.general-anzeiger-bonn.de/ga-english/news/rhine-level-in-bonn-is-currently-rising-rapidly_aid-48739343). 
